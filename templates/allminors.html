<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="static/images/icon.png" type="image/png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TigerPlan</title>
 <!-- Include jQuery from a CDN -->
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<style> * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
#right-container {
  width: 65%; 
  float: left;
}

.minor-button {
    width: 100%;
    padding: 10px;
    margin: 0px;
    background-color: #F7A072;
    color: black;
    border: none;
    cursor: pointer;
    text-align: left;
    padding-left: 20px;
    font-size: 15px;
    border-radius: 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease-in-out;

    
    &:hover {
        transform: translateY(-2px); 
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
    }
}

.minor-button:nth-child(even) {
    background-color: coral;
    color: black;
}


.minor-button:nth-child(odd) {
    background-color: #FF9B42;
    color: black;
}

#drop-area {
  min-height: 450px;
  max-height: 450px;
  overflow-y: auto;
  background-color:  #ADD7cd; 
  border: 2px dashed #CCCCCC;
  border-radius: 5px;
  padding: 20px;
  display: flex;
  flex-wrap: wrap; 
  justify-content: space-between; 
  margin-bottom: 20px; 
}

.grid-item {
  width: calc(50% - 10px); 
  height: auto;
  margin-bottom: 10px;
  padding: 20px;
  background-color: #ffd699;
  border-radius: 20px;
  cursor: move;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  box-sizing: border-box;
}

#drop-area p {
  color: #666666; 
  font-size: 20px; 
}

#left-container {
  max-height: 764px;
  height: auto; 
  overflow-y: auto; 
  width: 20%;
  background-color: #F7A072; 
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
  margin-right: 120px;
  margin-left: 0px; 
  float: left;
  border-radius: 5px;
}

#class-input {
  width: 95%;
  padding: 10px;
  border: none;
  border-bottom: 1px solid #ccc;
  font-size: 16px;
  margin: 10px;
}

#class-list {
  padding: 10px;
}

body {
  background-color: #C8F6EB;
  font-family: 'Roboto Serif', serif;
}

#container {
  width: 80%;
  margin: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.course {
  padding: 20px;
  margin-bottom: 20px;
  background-color: #F7A072;
  border-radius: 20px;
  cursor: move;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.course h2, .course p {
  margin: 0;
}


.custom-link {
  text-decoration: none; 
  color: inherit; 
}

.clearfix::after {
  content: "";
  display: table;
  clear: both;
}

#recommend-minors-btn {
  display: block;
  width: 30%;
  align-items: center;
  margin-bottom: 50px;
}

@media (max-width: 1200px) and (min-width: 801px) {
   #right-container {
      float: left;
      margin-right: 0; 
    }
  }

  @media (max-width: 800px) {
    body {
      font-size: 14px; 
    }

    #container {
      width: 90%; 
    }

    #right-container {
      width: 100%; 
    }

    #left-container {
      width: 100%;
      min-height: 200px;
      max-height: 300px; 
      margin-left: auto;
      margin-right: auto;
      

    }

    #right-container, #left-container,#recommend-minors-btn{
      
      float: none;
    }

  }

</style>
<link rel="stylesheet" type="text/css" href= "{{ url_for('static',filename='styles/try_style.css') }}" >
</head>
<body>

  {% set username = username %}
  {% include 'header.html' %}

<main>
  <section id="allminors">
    <div id="left-container">
      <div id="minor-list">
        {% for minor in minors %}
        <button class="minor-button" data-code="{{ minor['code'] }}">
            {{ minor['code'] }} - {{ minor['name'] }}
          </button>
        {% endfor %}
      </div>
    </div> 
  </section>


  <div id="right-container">
    <section id="main-content">
        <p><span class="roboto">What minors are </span><span class="caveat">you</span><span class="roboto"> closest to?</span></p>
      </section>
      <p><center id = "sub">Click on a minor to see how close you are to earning it!</center></p>
      <br>
    <div id="minor-card-container">
    </div>
  </div>
</main>

<script>
  'use strict';
  $(document).ready(function() {
    var lastXHR;
    
    
    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }

    
    var debouncedFetchMinorInformation = debounce(function(minorCode) {
        
        if (lastXHR && lastXHR.readyState !== 4) {
            lastXHR.abort();
        }

        
        lastXHR = $.ajax({
            url: '/distance',
            method: 'GET',
            data: { code: minorCode },
            success: function(response) {
                $('#minor-card-container').html(response);
                adjustFontSize(); 
            },
            error: function(error) {
                console.error('Error fetching minor information:', error);
            }
        });
    }, 300);

    function adjustFontSize() {
        var nodes = document.querySelectorAll('.node');

        nodes.forEach(function(node) {
            var textLength = node.textContent.trim().length;
            var fontSize = 100 - (textLength * 2);
            node.style.fontSize = fontSize + '%';
        });
    }

    function adjustModalTitleSize() {
        console.log('Adjusting modal title size');
        var modalTitle = document.querySelector('.modal-title');
        var textLength = modalTitle.textContent.trim().length;

        var baseFontSize = 35; 
        var minFontSize = 25;
        var maxTextLength = 23; 

        console.log('Text length:', textLength);
        var fontSize;
        
        if (textLength <= maxTextLength) {
            fontSize = 55

        } else {
            fontSize = baseFontSize - (baseFontSize - minFontSize) * 2* (textLength / maxTextLength);
        }

        fontSize = Math.max(fontSize, minFontSize);
        fontSize = Math.min(fontSize, baseFontSize);

        
        modalTitle.style.fontSize = fontSize + 'px';
    }

    $(document).on('click', '.minor-button', function() {
        var minorCode = $(this).data('code');
        debouncedFetchMinorInformation(minorCode);
    });

    function generateHTML(jsonData) {
        function createNodeHtml(node) {
            const nodeElement = document.createElement('div');
            nodeElement.className = 'node';
            nodeElement.innerHTML = `
                <div class="reqname">${node.name} (${node.classes_taken}/${node.classes_needed})</div>
                <div class="details">
                    <div class="subreqname">Details</div>
                    <div class="summary-info">
                        <div>Classes taken: ${node.classes_taken}</div>
                        <div>Classes needed: ${node.classes_needed}</div>
                        <div>Classes remaining: ${node.classes_remaining}</div>
                        <div class="classlist">
                            <div class="classlist_label">Your Classes:</div>
                            <ul>
                                ${node.class_list.map(className => `<li>${className}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            return nodeElement;
        }

        function appendChildren(parentElement, children) {
            children.forEach(child => {
                const childElement = createNodeHtml(child);
                
                if (child.children && child.children.length > 0) {
                    childElement.querySelector('.details').innerHTML += `
                        <div class="reqname" style="font-size: 20px">More requirements:</div>
                        <div class="children-container"></div>
                    `;
                    const childrenContainer = childElement.querySelector('.children-container');
                    appendChildren(childrenContainer, child.children);
                    childElement.querySelector('.details').appendChild(childrenContainer);
                }
                parentElement.appendChild(childElement);
            });
        }

        const rootElement = document.createElement('div');
        rootElement.className = 'root-container';
        
        if (jsonData.children && jsonData.children.length > 0) {
            appendChildren(rootElement, jsonData.children);
        } else {
            rootElement.appendChild(createNodeHtml(jsonData));
        }

        return rootElement.outerHTML;
    }

    function openModal(minor, desc) {
        var modalId = minor + "-modal";
        var modal = document.getElementById(modalId);
        console.log(modal);
        if (modal) {
            modal.style.display = "block";
        }
        var modalContent = modal.querySelector(".modal-content");
        adjustModalTitleSize();

        var treeDescription = modalContent.querySelector(".grey-boxes").getAttribute("data-tree");
        
        console.log('treeDescription', treeDescription);

        if (!treeDescription) {
            modalContent.querySelector("#description").textContent = desc;
            modalContent.querySelector(".grey-boxes").innerHTML = "<p>You have no classes that count toward this minor!</p>";

            return;
        }

        var generatedHTML = generateHTML(JSON.parse(treeDescription));

        var htmlContainer = modalContent.querySelector(".grey-boxes");
        console.log("here is the generated html")
        console.log(generatedHTML)
        htmlContainer.innerHTML = generatedHTML;

        if (htmlContainer.childNodes.length) {
            attachToggleListeners();
        }

        let descriptionParagraph = modalContent.querySelector("#description");
        console.log('description paragraph', descriptionParagraph.textContent);
        
        descriptionParagraph.textContent = desc;
        modalContent.querySelector(".modal-descBox").style.overflowY = "auto";

        
        modalContent.querySelector(".grey-boxes").style.overflowY = "auto";
    }

    $(document).on('click', '.course-card', function() {
        var minor = $(this).data('minor');
        var desc = $(this).data('desc');
        openModal(minor, desc);
    });

    $(document).on('click', '.close', function() {
        $(this).closest(".modal").hide();
    });

    
    $(document).on('click', function(event) {
        if ($(event.target).hasClass("modal")) {
            $(".modal").hide();
        }
    });

    adjustFontSize();


});
    
</script>

</body>
</html>
