<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="static/images/icon.png" type="image/png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TigerPlan - Classboard</title>
<style> 
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}


#right-container {
  width: 65%;
  float: right;
  margin-right: 20px;
}

#drop-area {
  min-height: 450px;
  max-height: 450px;
  overflow-y: auto; 
  background-color:  #ADD7cd; 
  border: 2px dashed #CCCCCC;
  border-radius: 5px;
  padding: 20px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  margin-bottom: 20px;
}

.grid-item {
  width: calc(50% - 10px);
  height: auto;
  margin-bottom: 10px;
  padding: 20px;
  background-color: #ffd699;
  border-radius: 20px;
  cursor: move;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  box-sizing: border-box;
}

#drop-area p {
  color: #666666;
  font-size: 20px;
}

#left-container {
  min-height: 450px;
  max-height: 450px;
  overflow-y: auto;
  width: 30%;
  background-color: #0FA3B1;
  border-radius: 5px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  margin-right: 20px;
  margin-left: 20px;
  margin-bottom: 20px;
  float: left;
}

#char-limit-warning {
    display: none;
    color: #ffe6b3;
    font-size: 16px;
    padding-left: 20px;
}

#class-input {
  width: 95%;
  padding: 10px;
  border: none;
  border-bottom: 1px solid #ccc;
  font-size: 16px;
  margin: 10px; 
}

#class-list {
  padding: 10px;
}

body {
  background-color: #C8F6EB;
  font-family: 'Roboto Serif', serif;
}

#container {
  width: 80%;
  margin: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.course {
  padding: 20px;
  margin-bottom: 20px;
  background-color: #F7A072;
  border-radius: 20px;
  cursor: move;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.course h2, .course p {
  margin: 0;
}


.custom-link {
  text-decoration: none;
  color: inherit;
}

.clearfix::after {
  content: "";
  display: table;
  clear: both;
}

#recommend-minors-btn {
  display: block;
  width: 40%;
  align-items: center;
  margin-bottom: 50px;
  margin-top: 0;
  margin-left: auto;
  margin-right: 30%;
  font-size: 2em;
}

.remove-course-btn {
   background-color: coral;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 20px;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }

   @media (max-width: 1200px) and (min-width: 801px) {
   #right-container {
      float: left;
      margin-right: 0;
    }
  }

  @media (max-width: 800px) {
    body {
      font-size: 14px;
    }

    #container {
      width: 90%;
    }

    #right-container {
      width: 100%;
    }

    #left-container {
      width: 75%;
      min-height: 200px;
      max-height: 300px;
      margin-left: auto;
      margin-right: auto;
      

    }

    #right-container, #left-container,#recommend-minors-btn{
      
      float: none;
    }

    #class-input {
      width: 96%;
      font-size: 0.9em; 
    }

    .grid-item {
      width: 100%;
      font-size: 0.9em; 
    }
    #recommend-minors-btn {
      margin-left: auto;
      margin-right: auto;
      font-size: 1.5em;
    }
  }

</style>
<link rel="stylesheet" type="text/css" href= "{{ url_for('static',filename='styles/try_style.css') }}" >
</head>
<body>

  {% set username = username %}
  {% include 'header.html' %}

<main>
  <section id="main-content" ondrop="drop(event)" ondragover="allowDrop(event)">
    <p><span class="roboto">What's </span><span class="caveat">your </span><span class="roboto">best minor?</span></p>
  </section>
  <p><center id="sub">Search for classes you've taken and drag them to your class board!</center></p>
  <br>
  
  <section id="class-selection">
    <div id="left-container" ondrop="drop(event)" ondragover="allowDrop(event)">
      <input type="text" id="class-input" placeholder="Search classes..." maxlength="60" oninput="checkInputLength()" autofocus="true">
      <div id="char-limit-warning">Character limit reached!</div>

      <div id="class-list">
      </div>
    </div> 
  </section>


  <div id="right-container">
    <div id="drop-area" ondrop="drop_area(event)" ondragover="allowDrop(event)">
      <center id="placeholder"><p>Drag your classes here</p></center>
    </div>
    <div id="button-container"> 
      <center>
        <button id="recommend-minors-btn" onclick="window.location.href='/recommend'">Recommend Minors</button>
      </center>
    </div>
  </div>


  
</main>

<script>

  'use strict';
  function displayMessage() {
    let dropArea = document.getElementById('drop-area');
    console.log(`Drop area has ${dropArea.children.length} children`);

    if (dropArea.children.length === 0) {
      console.log(`Placeholder not found!`);
      dropArea.innerHTML = '<center id="placeholder"><p>Drag your classes here</p></center>';
    } else {
      console.log(`Child 0 id is ${dropArea.children[0].id}`);
      if (dropArea.children[0].id === 'placeholder') {
        console.log(`Placeholder found!`);
        dropArea.removeChild(dropArea.children[0]);
      }
    }
  }

  function checkInputLength() {
    var input = document.getElementById("class-input");
    var maxLength = parseInt(input.getAttribute("maxlength"));
    var currentLength = input.value.length;
    var warningMsg = document.getElementById("char-limit-warning");

    if (currentLength >= maxLength) {
        input.value = input.value.slice(0, maxLength);
        warningMsg.style.display = "block";
    } else {
        warningMsg.style.display = "none";
    }
  }

  function allowDrop(ev) {
    ev.preventDefault();
  }


  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
  }

  function drop_area(ev) {
    ev.preventDefault();
    console.log(`Drop area called!`);
    
    let data = ev.dataTransfer.getData("text");
    let dropArea = document.getElementById('drop-area');
    console.log(`Drop area has ${dropArea.children.length} children`)
    console.log(`Data is ${data}`)

    if (data.includes('container')) {
      return;
    }

    let id = data + '-container';
    console.log(`ID is ${id}`);
    let existingElement = document.getElementById(id);
    if (existingElement) {
        return;
    }

    
    let courseElement = document.getElementById(data);
    courseElement.style.backgroundColor = '#ffd699';
    let courseId = courseElement.id;
    console.log(`Adding course: ${courseId}`)
    let courseNum = courseElement.querySelector('h2').textContent;
    let courseTitle = courseElement.querySelector('p').textContent;

    addCourseToDropArea(courseId, courseNum, courseTitle);

    let encodedCourseId = encodeURIComponent(courseId);
    let encodedCourseNum = encodeURIComponent(courseNum);
    let encodedCourseTitle = encodeURIComponent(courseTitle);

    let url = `/addcourse?courseId=${encodedCourseId}&courseNum=${encodedCourseNum}&title=${encodedCourseTitle}`;


    let request = new XMLHttpRequest();
    request.open('POST', url);
    request.onload = function() {
      if (request.status >= 200 && request.status < 400) {
        console.log('Course successfully added to database');
        load_area();
        let courseElement = document.getElementById(data);
        courseElement.style.backgroundColor = '#ffd699';
      } else {
        console.error('Error: Failed to add course to database');
        courseElement.style.backgroundColor = '#F7A072';
      }
    };
    request.onerror = function() {
      console.error('Error: Request to add course failed');
    };
    request.send();
  }


  function addCourseToDropArea(courseId, courseNum, courseTitle) {
    let dropArea = document.getElementById('drop-area');

    const newCourseContainer = document.createElement('div');
    newCourseContainer.classList.add('grid-item');
    newCourseContainer.id = courseId + '-container';
    newCourseContainer.draggable = true;
    newCourseContainer.ondragstart = function() { drag(event); };


    newCourseContainer.innerHTML = `
    <div class="left-course-info">
          <h2 id="deptnum">${courseNum}</h2>
          <p id="title">${courseTitle}</p>
        </div>
        <div class="right-course-info">
          <button class="remove-course-btn" data-course-id="${courseId}">-</button>
        </div>
    `;

    dropArea.appendChild(newCourseContainer);
    displayMessage();

    dropArea.scrollTop = dropArea.scrollHeight;
  }


  function drop(ev) {
    ev.preventDefault();
    let data = ev.dataTransfer.getData("text");
    let courseElement = document.getElementById(data);
    let resultsId = data.slice(0, data.indexOf('-container'));
    let resultsElement = document.getElementById(resultsId);
    resultsElement.style.backgroundColor = '#F7A072';

    if (courseElement && data.includes('container')) {
      let courseId = courseElement.id.slice(0, courseElement.id.indexOf('-container'));
      console.log(`Removing course: ${courseId}`)

      courseElement.parentNode.removeChild(courseElement);
      displayMessage();

      let encodedCourseId = encodeURIComponent(courseId);

      let url = `/removecourse?courseId=${encodedCourseId}`;

      let request = new XMLHttpRequest();
      request.open('POST', url);
      request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
          console.log('Course successfully removed from database');
          load_area();
          let resultsElements = document.querySelectorAll('[id="' + courseId + '"]');
          resultsElements.forEach(resultsElement =>
            resultsElement.style.backgroundColor = '#f7a072'
        )} else {
          console.error('Error: Failed to remove course from database');
          resultsElement.style.backgroundColor = '#ffd699';
        }
      };
      request.onerror = function() {
        console.error('Error: Request to remove course failed');
      };
      request.send();
    }
  }

function handleSearchResponse() {
    if (this.status !== 200) {
        alert('Error: Failed to fetch data from server');
        return;
    }
    let resultsDiv = document.getElementById('class-list');
    resultsDiv.innerHTML = this.responseText;

    let resultsCourses = resultsDiv.querySelectorAll('.course');
    let dropArea = document.getElementById('drop-area');
    let dropCourses = dropArea.querySelectorAll('.grid-item');

    resultsCourses.forEach(courseContainer => {
        let courseId = courseContainer.id.split('-')[0];
        let alreadyInDropArea = Array.from(dropCourses).some(dropCourse => {
            return dropCourse.id.startsWith(courseId + '-');
        });
        
        if (alreadyInDropArea) {
            courseContainer.style.backgroundColor = '#ffd699';
        }
        else {
            courseContainer.style.backgroundColor = '#F7A072';
        }
    });
}


  function handleSearchError() {
    alert('Error: Failed to fetch data from server');
  }


  function getResults() {
    let courseInput = document.getElementById('class-input');
    let course = courseInput.value;
    let encodedCourse = encodeURIComponent(course);
    let url = '/searchresults?course=' + encodedCourse;

    let request = new XMLHttpRequest();
    request.onload = handleSearchResponse;
    request.onerror = handleSearchError;
    request.open('GET', url);
    request.send();
  }


  let timer = null;
  function debouncedGetResults() {
    clearTimeout(timer);
    timer = setTimeout(getResults, 500);
  }

  function setup() {
    let courseInput = document.getElementById('class-input');
    courseInput.addEventListener('input', debouncedGetResults);
  }

  function load_area() {
    let dropArea = document.getElementById('drop-area');
    let url = '/loadarea';

    let request = new XMLHttpRequest();
    request.onload = function() {
      if (request.status === 200) {
        dropArea.innerHTML = request.responseText;
      } else {
        alert('Error: Failed to load classes');
      }
    };
    request.onerror = function() {
      alert('Error: Failed to load classes');
    };
    request.open('GET', url);
    request.send();
  }

  function addCourse(courseId) {
    let courseElement = document.getElementById(courseId);
    courseElement.style.backgroundColor = '#ffd699';
    if (courseElement) {

      let dropArea = document.getElementById('drop-area');

      let id = courseId + '-container';
      let existingElement = document.getElementById(id);
      if (existingElement) {
          return;
      }
      else {
        let courseNum = courseElement.querySelector('h2').textContent;
        let courseTitle = courseElement.querySelector('p').textContent;

        addCourseToDropArea(courseId, courseNum, courseTitle);


        let encodedCourseId = encodeURIComponent(courseId);
        let encodedCourseNum = encodeURIComponent(courseNum);
        let encodedCourseTitle = encodeURIComponent(courseTitle);

        let url = `/addcourse?courseId=${encodedCourseId}&courseNum=${encodedCourseNum}&title=${encodedCourseTitle}`;

        let request = new XMLHttpRequest();
        request.open('POST', url);
        request.onload = function() {
          if (request.status >= 200 && request.status < 400) {
            console.log('Course successfully added to database');
            load_area();
            let courseElement = document.getElementById(courseId);
            courseElement.style.backgroundColor = '#ffd699';
          } else {
            console.error('Error: Failed to add course to database');
            courseElement.style.backgroundColor = '#F7A072';
          }
        };
        request.onerror = function() {
          console.error('Error: Request to add course failed');
        };
        request.send();
      }
    }
  }

  function removeCourse(courseId) {
    console.log(`Removing course: ${courseId}`)
    let courseElement = document.getElementById(courseId);
    let resultsId = courseId.slice(0, courseId.indexOf('-container'));
    let resultsElement = document.getElementById(resultsId);
    resultsElement.style.backgroundColor = '#F7A072'; 

    if (courseElement) {
      let id = courseId.slice(0, courseId.indexOf('-container'));

      courseElement.parentNode.removeChild(courseElement);
      displayMessage();

      let encodedCourseId = encodeURIComponent(id);

      let url = `/removecourse?courseId=${encodedCourseId}`;

      let request = new XMLHttpRequest();
      request.open('POST', url);
      request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
          console.log('Course successfully removed from database');
          load_area();
          let resultsElement = document.getElementById(resultsId);
          resultsElement.style.backgroundColor = '#f7a072';
        } else {
          console.error('Error: Failed to remove course from database');
          resultsElement.style.backgroundColor = '#ffd699';
        }
      };
      request.onerror = function() {
        console.error('Error: Request to remove course failed');
      };
      request.send();
    }
  }

  
  document.addEventListener('DOMContentLoaded', setup);
  document.addEventListener('DOMContentLoaded', load_area);

  document.addEventListener('click', function(event) {
    if (event.target && event.target.classList.contains('add-course-btn')) {
      let courseId = event.target.getAttribute('data-course-id');
      addCourse(courseId);
    }
  });

  document.addEventListener('click', function(event) {
    if (event.target && event.target.classList.contains('remove-course-btn')) {
      let courseId = event.target.getAttribute('data-course-id');
      removeCourse(courseId);
    }
  });
</script>

</body>
</html>
